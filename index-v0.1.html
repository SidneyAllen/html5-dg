<!DOCTYPE html> 
<html>
<head>
<meta charset="UTF-8">
<title>jQuery HTML 5 Web App</title>
<script src="js/jquery-1.6.2.min.js" type="text/javascript"></script>


<script src ="https://www.paypalobjects.com/js/external/dg.js" type="text/javascript"></script>
<script>

var session;


// CONNECT 
$.extend({
	connect : function(args, callbackFnk){
		var currURL = args.url;
		var currData = args.data;
		$.ajax({
			url: currURL,
			data: currData,
			success: function(data){
				var obj = $.parseJSON(data);
				
				if(typeof callbackFnk == 'function'){
					callbackFnk.call(this, obj);
				}
			}
		});	
	}
});


// BUTTONCREATE
$.extend({
	createButton : function(args, callbackFnk){
		var currURL = args.url;
		var currData = args.data;
		$.ajax({
			url: currURL,
			data: currData,
			success: function(data){
				var obj = $.parseJSON(data);
				
				if(typeof callbackFnk == 'function'){
					callbackFnk.call(this, obj);
				}
			}
		});	
	}
	
});



// GENERATE BUTTON
$.extend({
	generateButton : function(args){
		var currURL = args.url;
		var currData = args.data;
		var currSession = args.session;
		var currTarget = args.target;
		
		var args = {'url':'/html5dg/connect.cfc','data':'method=setExpressCheckout'};
			$.setExpressCheckout(args, function(data){
				// assign connection data to global session var
				console.log(data);
				
				var buttonData = "<a href='" + data.redirecturl  +"' id='" + currSession.buttonId +"'><img src='https://www.sandbox.paypal.com/en_US/i/btn/btn_buynow_LG.gif' border='0' /></a>";
		
		
				$(currTarget).html(buttonData);
				
				
				var dg = new PAYPAL.apps.DGFlow({
				// the HTML ID of the form submit button which calls setEC
					trigger: currSession.buttonId
				});
				
				
			});
			/*
		var buttonData = "<a href='http://www.google.com' id='" + currSession.buttonId +"'><img src='https://www.sandbox.paypal.com/en_US/i/btn/btn_buynow_LG.gif' border='0' /></a>";
		
		
		$(currTarget).html(buttonData);
		
		var dg = new PAYPAL.apps.DGFlow({
		// the HTML ID of the form submit button which calls setEC
			trigger: currSession.buttonId
		});
		*/
		
		/*
		$('#' +  currSession.buttonId).live('click', function() {	
			//alert('Set Express Checkout ' +  currSession.buttonId);
			var args = {'url':'/html5dg/connect.cfc','data':'method=setExpressCheckout'};
			$.setExpressCheckout(args, function(data){
				// assign connection data to global session var
				console.log(data);
			});
		});
		*/
	}
});

// SETEXPRESSCHECKOUT
$.extend({
	setExpressCheckout : function(args, callbackFnk){
		var currURL = args.url;
		var currData = args.data;
		$.ajax({
			url: currURL,
			data: currData,
			success: function(data){
				var obj = $.parseJSON(data);
				
				if(typeof callbackFnk == 'function'){
					callbackFnk.call(this, obj);
				}
			}
		});	
	}
});




$(document).ready(function() {
	
	$('#connect').click(function() {	
		var args = {'url':'/html5dg/connect.cfc','data':'method=connect'};
		$.connect(args, function(data){
			// assign connection data to global session var
			session = data;
		});
	});
	
	$('#dispatch').click(function() {
		console.log(session);
	});
	
	
	$('#createButton').click(function() {	

		var args = {'url':'/html5dg/connect.cfc','data':'method=createButton','target':'#MyButtonTarget','session':session};
		$.createButton(args, function(data){
			
			console.log(data);
			var args = {'url':'/html5dg/connect.cfc','data':'method=createButton','target':'#MyButtonTarget','session':data};
			$.generateButton(args, function(data){
				console.log(data);
			});
		});
		
	});
	
		$('#drawButton').click(function() {	
			draw_b();
		});
	
	
});



function draw_b() {
	var canvas = document.getElementById("myCanvas");
	var context = canvas.getContext("2d");
	//b_context.fillRect(50, 25, 150, 100);
  
	
	buttonObj.src = "https://www.sandbox.paypal.com/en_US/i/btn/btn_buynow_LG.gif";
	console.log(context);
	buttonObj.onload = function() {
   		context.drawImage(buttonObj, 50,50, 130, 30);
  	};
}


</script>
</head> 
<body> 

<button  id="connect">Connect</button>
<br>
<button id="dispatch">Display Session Obj in Console</button>
<br/>
<button id="createButton">Create Button</button>

<button id="drawButton">draw Button</button>

<div id="MyButtonTarget"></div>



<canvas id="mainCanvas" width="550" height="400">
        Your browser does not support the canvas element.
        </canvas>
        <br /><span id="outputSpan"></span>
        <br /><span id="mouseXYSpan"></span>
 
        <script type="text/javascript">
            var canvasContext;
            var myButton = new Object();
			var myContainer = new Object();
			var buttonObj = new Image();

            var mouseX = 0;
            var mouseY = 0;
            var backgroundImage = new Image();
            var BUTTON_COLOR_DARK = "rgb(0, 0, 255)";
            var BUTTON_COLOR_LIGHT = "rgb(0, 0, 128)";
			var FRAME_COLOR_WHITE = "rgb(255, 255, 255)";
 
            function drawButton(buttonObj)
            {
                canvasContext.fillStyle = buttonObj.rgb;
                canvasContext.fillRect (buttonObj.x, buttonObj.y, buttonObj.width, buttonObj.height);
            }
 
            function checkIfInsideButtonCoordinates(buttonObj, mouseX, mouseY)
            {
                if(((mouseX > buttonObj.x) && (mouseX < (buttonObj.x + buttonObj.width))) && ((mouseY > buttonObj.y) && (mouseY < (buttonObj.y + buttonObj.height))))
                    return true;
                else
                    return false;
            }
 
            $(function() {
                var canvas = $("#mainCanvas").get(0);
                canvasContext = canvas.getContext('2d');
                backgroundImage.src = "angrybirds.png";
 
                $(backgroundImage).load(function() {
                    canvasContext.drawImage(backgroundImage, 0, 0);
                   
					// Offer Container area
					myContainer.x = 350;
                    myContainer.y = 250;
                    myContainer.width = 180;
                    myContainer.height = 100;
                    myContainer.rgb = FRAME_COLOR_WHITE;
                    drawButton(myContainer);
					
					// Hit Area 
					myButton.x = 375;
                    myButton.y = 295;
                    myButton.width = 130;
                    myButton.height = 40;
                    //myButton.rgb = BUTTON_COLOR_LIGHT;
                    drawButton(myButton);
					
					buttonObj.src = "https://www.sandbox.paypal.com/en_US/i/btn/btn_buynow_LG.gif";
					buttonObj.onload = function() {
						canvasContext.drawImage(buttonObj, 375,300, 130, 30);
					};
                });
 
                $("#mainCanvas").click(function(eventObject) {
                    mouseX = eventObject.pageX - this.offsetLeft;
                    mouseY = eventObject.pageY - this.offsetTop;
 
                    if(checkIfInsideButtonCoordinates(myButton, mouseX, mouseY))
                    {
						console.log('hit area');
                        //$('#outputSpan').fadeIn("fast");
                       // $("#outputSpan").html("You clicked the button");
                       // $('#outputSpan').fadeOut("slow");
                    }
                });
 
                $("#mainCanvas").mousemove(function(eventObject) {
                    mouseX = eventObject.pageX - this.offsetLeft;
                    mouseY = eventObject.pageY - this.offsetTop;
 
                    $("#mouseXYSpan").html("X: " + mouseX + "   Y: " + mouseY);
 					
					/*
                    if(checkIfInsideButtonCoordinates(myButton, mouseX, mouseY))
                        myButton.rgb = BUTTON_COLOR_DARK;
                    else
                        myButton.rgb = BUTTON_COLOR_LIGHT;
 
                    drawButton(myButton);
					*/
                });
            });
        </script>
</body>
</html>
